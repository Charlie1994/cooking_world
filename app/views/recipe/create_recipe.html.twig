{% extends "generalTemplate.html.twig" %}
{% block description %}
    Cooking World, Creating personal recipes.
{% endblock %}
{% block cssfiles %}
    <link rel="stylesheet" href="{{rootpath}}public/css/sortableListView.css" type="text/css"/>
    <link rel="stylesheet" href="{{rootpath}}public/css/dragImageBox.css" type="text/css"/>
    <link rel="stylesheet" href="{{rootpath}}public/css/addPhotoBox.css" type="text/css"/>
    <link rel="stylesheet" href="{{rootpath}}public/css/loading.css" type="text/css"/>
{% endblock %}
{% block title %}
    Create Recipe
{% endblock %}
{% block extra_body %}
    <div class="create-container">
        <div class="create-background"></div>
    </div>
{% endblock %}
{% block body %}
    <div class="row">
        <div class="col-sm-offset-2 col-sm-8 create-recipe-body">
            <div class="row">
                <div class="col-sm-6">
                    <div class="create-main-upload-box">
                        <div class="no-photo add-photo-box">
                            <img src="" class="img-rounded display-img">
                            <img src="{{ resourcepath }}/images/ic_camera_128px.png" class="img-rounded icon-camera">
                            <div class="add-photo-btn btn btn-primary">Add a photo</div>
                            <div class="change-photo-btn"><i class="fa fa-refresh" aria-hidden="true"></i>
                            </div>
                            <div class="delete-photo-btn"><i class="fa fa-trash" aria-hidden="true"></i>
                            </div>
                        </div>
                        <div class="padding-box"></div>
                    </div>
                </div>
                <div class="col-sm-6">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group">
                                <label for="recipe-name"><strong>Recipe Name</strong></label>
                                <input id="recipe-name" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="course"><strong>Course</strong></label>
                                <select id="course" class="form-control">
                                    <option value="Soup">Soup</option>
                                    <option value="Appetizer">Appetizer</option>
                                    <option value="Salads">Salads</option>
                                    <option value="Bread">Bread</option>
                                    <option value="Beverage">Beverage
                                    </option>
                                    <option value="Dessert">Dessert</option>
                                    <option value="Main_Dish">Main Dish</option>
                                    <option value="Sauce">Sauce</option>
                                    <option value="Side_Dish">Side Dish</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div class="form-group">
                                <label for="level"><strong>Level</strong></label>
                                <select id="level" class="form-control">
                                    <option value="easy">Easy</option>
                                    <option value="medium">Medium</option>
                                    <option value="hard">Hard</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-5">
                            <div class="form-group">
                                <label for="time"><strong>Time(minutes)</strong></label>
                                <input id="time" type="text" class="form-control">
                            </div>
                        </div>
                        <div class="col-sm-7">
                            <div class="form-group">
                                <label for="number-of-servings"><strong>Number of Servings</strong></label>
                                <input id="number-of-servings" type="text" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="create-form-body">
                <div class="row">
                    <strong>Description</strong>
                    <div class="form-group">
                        <textarea title="description" style="margin-top: 8px" id="description" rows="3" class="form-control"></textarea>
                    </div>
                </div>
                <div class="row ingredients">
                    <strong>Ingredients</strong>
                    <div class="row ingredient-labels">
                        <div class="col-sm-4">
                            <p>Quantity</p>
                        </div>
                        <div class="col-sm-8">
                            <p>Ingredient Name</p>
                        </div>
                    </div>
                    <hr>
                    <div class="ingre-items sortable-list">
                        {% for i in 1..3 %}
                            <div class="item sortable-item">
                                <div class="row">
                                    <div class="col-sm-4">
                                        <input title="ingredient quantity" type="text" class="form-control">
                                    </div>
                                    <div class="col-sm-6 col-sm-offset-1">
                                        <input title="ingredient name" type="text" class="form-control">
                                    </div>
                                    <div class="col-sm-1 sortable-btns">
                                        <div class="sortable-btn delete-btn">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </div>
                                        <div class="sortable-btn add-btn">
                                            <i class="fa fa-plus" aria-hidden="true"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <br>
                <div class="row directions">
                    <strong>Directions</strong>
                    <hr>
                    <div class="direction-items sortable-list">
                        {% for i in 1..3 %}
                            <div class="sortable-item direction-item" data-index="{{ i }}">
                                <div class="row">
                                    <div class="item-content col-sm-11">
                                        <div class="wrap">
                                            <div class="step-num"><strong><i>{{ i }}</i></strong></div>
                                            <div class="row">
                                                <div class="col-sm-3">
                                                    <div class="add-photo-box no-photo">
                                                        <img src="" class="img-rounded display-img">
                                                        <img src="{{ resourcepath }}/images/ic_camera_128px.png" class="img-rounded icon-camera">
                                                        <div class="add-photo-btn btn btn-primary">Add a photo</div>
                                                        <div class="change-photo-btn"><i class="fa fa-refresh" aria-hidden="true"></i>
                                                        </div>
                                                        <div class="delete-photo-btn"><i class="fa fa-trash" aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="col-sm-9 direction-content">
                                                    <textarea class="form-control" title="instruction" rows="3"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-sm-1 sortable-btns">
                                        <div class="sortable-btn drag-btn">
                                            <i class="fa fa-arrows" aria-hidden="true"></i>
                                        </div>
                                        <div class="sortable-btn delete-btn">
                                            <i class="fa fa-times" aria-hidden="true"></i>
                                        </div>
                                        <div class="sortable-btn add-btn">
                                            <i class="fa fa-plus" aria-hidden="true"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                <br>
                <div class="row tags">
                    <strong>Tags</strong>
                    <hr>
                    <div class="tagsinput-primary">
                        <input id="tags" title="tags" name="tagsinput" class="tagsinput" data-role="tagsinput" value="" />
                    </div>
                </div>
            </div><br>
            <div class="row">
                <div class="btn btn-block btn-primary" id="publish-btn">Publish</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="loading-modal" tabindex="-1" role="dialog" aria-hidden="true" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog">
            <div class="modal-content" >
                <div class="modal-body loading-body" style="text-align: center">
                    <strong class="loading-label">Uploading...</strong>
                    <div class="loader"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {% include 'components/confirmModal.html' %}
    {% include 'components/displayImageModal.html' %}
    {% include 'components/uploadImageModal.html' %}
    <!--Loading js files-->
    <script src="{{rootpath}}public/js/addPhotoBox.js" type="text/javascript"></script>
    <script src="{{rootpath}}public/js/dragDropImg.js" type="text/javascript"></script>
    <script src="{{rootpath}}public/js/sortableListView.js" type="text/javascript"></script>
    <script type="text/javascript">
        "use strict";
        +(function($, window, document, undefined){
            $('body').addClass("create-body");
            $('.create-form-body .directions .direction-items.sortable-list').each(function () {
                var $itemlist = $(this),
                    $items = $itemlist.find('.direction-item');
                $items.each(function () {
                    var $item = $(this),
                        $photobox = $item.find('.add-photo-box'),
                        $content = $item.find('.direction-content'),
                        itemheight = $content.height();
                    $photobox.css('height', itemheight+'px');
                });
                $itemlist
                    .on('itemAdded', function (e, $item) {
                        $item.find('.add-photo-box').initAddPhotoBox();
                    })
                    .on('orderChanged', function (e, itemarray) {
                        itemarray.forEach(function (item) {
                            var stepnumlabel = item.find('.step-num i'),
                                stepnum = itemarray.indexOf(item)+1;
                            stepnumlabel.text(stepnum);
                            item.attr('data-index', stepnum);
                        })
                    });
            });
            $('#publish-btn').on('click', function () {
                $('#loading-modal').modal('show');
                var $steps = $('.directions .direction-items .direction-item'),
                    $ingredients = $('.ingredients .ingre-items .item'),
                    count = 0;
                $.ajax({
                    url: '{{ rootpath }}recipe/publish',
                    method: 'POST',
                    data:{
                        'recipename': $('#recipe-name').val(),
                        'course': $('#course').val(),
                        'level': $('#level').val(),
                        'cooktime': $('#time').val(),
                        'serving': $('#number-of-servings').val(),
                        'description': $('#description').val(),
                        'photo': $('.create-main-upload-box .display-img').attr('src'),
                        'tags': $('#tags').val()
                    },
                    success: function (result) {
                        var r = JSON.parse(result);
                        if(r.status != 200){
                            alert(r.msg);
                        }else{
                            var recipeid = r.msg,
                                ingre_array = Array(),
                                step_array = Array();
                            $ingredients.each(function () {
                                var item = $(this),
                                    quantity = item.find('input[title="ingredient quantity"]').val(),
                                    name = item.find('input[title="ingredient name"]').val();
                                ingre_array.push({
                                    'quantity': quantity,
                                    'name': name
                                });
                            });
                            $steps.each(function () {
                                var item = $(this),
                                    hasphoto = item.find('.add-photo-box').hasClass('has-photo'),
                                    image = item.find('.display-img').attr('src'),
                                    content = item.find('textarea[title="instruction"]').val(),
                                    stepnum = item.data('index');
                                step_array.push({
                                    'stepnum': stepnum,
                                    'content': content,
                                    'image': image,
                                    'hasphoto': hasphoto
                                });
                            });
                            $.ajax({
                                url: '{{ rootpath }}recipe/upload/step',
                                method: 'POST',
                                data:{
                                    'recipeid': recipeid,
                                    'steps': step_array
                                },
                                success: function (result) {
                                    count += 1;
                                    if (count == 2){
                                        // $('#loading-modal').modal('hide');
                                        window.location.replace("{{ rootpath }}recipe&id=" + recipeid);
                                    }
                                }
                            });
                            $.ajax({
                                url: '{{ rootpath }}recipe/upload/ingredient',
                                method: 'POST',
                                data:{
                                    'recipeid': recipeid,
                                    'ingredients': ingre_array
                                },
                                success: function (result) {
                                    count += 1;
                                    if (count == 2){
                                        // $('#loading-modal').modal('hide');
                                        window.location.replace("{{ rootpath }}recipe&id=" + recipeid);
                                    }
                                }
                            });
                        }
                    }
                });

            });
        })(jQuery, window, document);
    </script>
{% endblock %}